# Backend 项目结构

## 2026.1.1

```
E:\研究生\中医BENCHMARK\ACUPUNCTUREEVAL\BACKEND
│  acue_app.db
│  init_db.py
│  main.py         #程序主入口
│  README.md
│  README_IMPORTS.md
│  test.py
│  更新日志.md
│
├─core
│  │  database.py     #数据库链接
│  │  __init__.py     
│
├─dao     #数据库操作文件
│  │  qa_leaderboard_dao.py
│  │  vqa_leaderboard_dao.py
│  │  __init__.py
│  
├─datasets   #存放标准答案（qa还没要到）
│  ├─qa
│  └─vqa
│      ├─第一类题型
│      │      单选题_324题.json
│      │      多选题_600题.json
│      │
│      ├─第三类题型
│      │      针灸操作题_35题.json
│      │
│      └─第二类题型
│              定位题_37题.json
│
├─files
├─model     #数据库表映射文件
│  │  qaLeaderboard.py     
│  │  vqaLeaderboard.py
│  │  __init__.py
│
├─router   #路由文件
│      qaRouter.py
│      vqaRouter.py
│      __init__.py
```

项目启动命令

```powershell
fastapi dev main.py
```
我用conda create -n acue python=3.12 来创建环境

主要逻辑在router文件中，包括用户上传文件预检查、计算正确率，获取排行榜数据等。

使用的sqlLite数据库，没有可视化页面，现在将已经咱们跑完的分数录入数据库了，可以运行test.py文件来查看数据表中内容

## 2026.1.2

### 新增功能

1. **抽象公共评测模块**（backend/core/eval.py）
   - 统一了文件解析、数据验证、对齐策略和计分逻辑
   - 支持字段名兼容（output/Output、answer/Answer、ID/id等）
   - 提供单选题和多选题的标准化计分函数
   - 支持按ID对齐和按顺序对齐两种策略
   - 统一错误处理和日志记录

2. **重构VQA router**
   - 使用公共评测模块替换原有逻辑
   - 保持API接口不变，提升代码复用性和可维护性

3. **实现QA router**（backend/router/qaRouter.py）
   - 实现 POST /qa/evaluate 接口：上传6个JSON文件（A1/A2/A3/A4/B/X），自动评分并记录
   - 实现 GET /qa/data 接口：分页查询QA排行榜数据
   - 支持扁平题型（A1/A2/X单选、多选）和分组题型（A3/A4/B共享题干或选项）
   - 复用公共评测模块，确保评测逻辑一致性

4. **完善QA DAO**
   - 为 get_all_sorted_by_score 添加分页参数（skip/limit）

5. **挂载QA router到main.py**
   - QA API现已可用，访问 /docs 查看完整接口文档

6. **新增冒烟测试预测生成脚本**（backend/scripts/generate_test_predictions.py）
   - 从标准答案自动生成“100%正确”的预测文件
   - 覆盖 VQA（4文件）与 QA（6文件），用于快速回归验证
   - 输出目录：backend/scripts/test_predictions/

7. **强化分组题型（A3/A4/B）结构校验**（backend/core/eval.py）
   - 校验父题 ID 是否存在
   - 校验 outputs 字段类型（必须为列表）
   - 校验子题数量与标准答案一致，避免静默错对齐

8. **增加数据一致性检查（ID 统计）**（backend/core/eval.py）
   - 检查预测数据中的重复 ID
   - 统计缺失 ID / 多余 ID / 覆盖率
   - 默认非严格模式：仅日志告警、不阻断评分（便于兼容历史数据）

9. **增强多选答案兼容性**（backend/core/eval.py）
   - 支持多种输入格式："A,C" / "A C" / "AC" / ["A","C"]
   - 统一大写、去重、排序

### 剩余内容

1. ~~qa选择题的router没写~~ ✅ 已完成
2. ~~qa的router的处理逻辑写了，可以将vqa的router中文件预检查和计算正确率部分抽象成公共函数。~~ ✅ 已完成

3. 前后端尚未打通：前端排行榜目前为 mock 数据（建议下一步仅先对接 /qa/data 与 /vqa/data）

### 2026.1.2（补充）

1. **QA 标准答案文件重命名**（datasets/qa）
   - 将 `merged_*.json` 统一更名为 `A1.json/A2.json/A3.json/A4.json/B.json/X.json`
   - 同步更新后端代码引用与冒烟预测生成脚本

2. **文档分层（方案B）**
   - 根目录 README 作为概览与索引
   - backend/README.md / frontend/README.md 分别承载后端与前端细节
